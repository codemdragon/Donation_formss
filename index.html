<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ration Distribution System</title>
    <style>
        :root {
            --primary: #2563eb;
            --primary-dark: #1e40af;
            --success: #059669;
            --bg: #f3f4f6;
            --card: #ffffff;
            --text: #1f2937;
            --border: #e5e7eb;
            --danger: #dc2626;
            --warning: #f59e0b;
        }

        * {
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 0;
        }

        body {
            background-color: var(--bg);
            color: var(--text);
            line-height: 1.6;
        }

        .hidden {
            display: none !important;
        }

        .fade-in {
            animation: fadeIn 0.3s ease-in-out;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
            }

            to {
                opacity: 1;
            }
        }

        nav {
            background: var(--primary-dark);
            color: white;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            position: sticky;
            top: 0;
            z-index: 50;
        }

        .nav-inner {
            max-width: 1400px;
            margin: 0 auto;
            padding: 14px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 10px;
        }

        .nav-brand {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 1.3rem;
            font-weight: 700;
        }

        #nav-branch-name {
            font-weight: 400;
            font-size: 0.9rem;
            opacity: 0.9;
            background: rgba(255, 255, 255, 0.2);
            padding: 2px 8px;
            border-radius: 4px;
            white-space: nowrap;
        }

        #nav-actions button {
            padding: 6px 14px;
            border-radius: 6px;
            border: none;
            cursor: pointer;
            font-weight: 600;
            font-size: 0.9rem;
        }

        .nav-btn-danger {
            background: var(--danger);
            color: white;
        }

        .app-container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
            padding-bottom: 100px;
        }

        .card {
            background: var(--card);
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
            overflow: hidden;
        }

        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
            gap: 15px;
        }

        .form-group {
            margin-bottom: 5px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
            font-size: 0.9rem;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid var(--border);
            border-radius: 6px;
        }

        .cnic-container {
            display: flex;
            align-items: center;
            gap: 5px;
            flex-wrap: nowrap;
            overflow-x: auto;
        }

        .cnic-group {
            display: flex;
            gap: 4px;
        }

        .cnic-box {
            width: 32px;
            min-width: 25px;
            height: 40px;
            text-align: center;
            font-size: 1rem;
            font-weight: bold;
            border: 2px solid var(--border);
            border-radius: 6px;
            padding: 0;
        }

        .cnic-sep {
            font-weight: bold;
            color: #9ca3af;
        }

        .submit-btn {
            background: var(--primary);
            color: white;
            border: none;
            padding: 12px;
            border-radius: 6px;
            width: 100%;
            font-weight: bold;
            cursor: pointer;
            margin-top: 15px;
            transition: 0.2s;
        }

        .submit-btn:hover {
            background: var(--primary-dark);
        }

        .section-title {
            font-size: 1.2rem;
            margin-bottom: 15px;
            color: var(--primary-dark);
            border-bottom: 2px solid #e5e7eb;
            padding-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 10px;
        }

        .controls {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 20px;
            background: #f9fafb;
            padding: 15px;
            border-radius: 8px;
            align-items: center;
        }

        .controls input,
        .controls select {
            flex: 1;
            min-width: 140px;
            padding: 10px;
            border: 1px solid var(--border);
            border-radius: 6px;
        }

        .bulk-actions {
            background: #dbeafe;
            border: 1px solid #93c5fd;
            color: #1e40af;
            padding: 10px 15px;
            border-radius: 8px;
            margin-bottom: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 10px;
        }

        .btn-bulk-approve {
            background: var(--success);
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            font-weight: bold;
            cursor: pointer;
        }

        .btn-bulk-approve:hover {
            background: #047857;
        }

        .table-responsive {
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            min-width: 900px;
        }

        th,
        td {
            padding: 12px 15px;
            border-bottom: 1px solid var(--border);
            text-align: left;
            vertical-align: middle;
        }

        th {
            background: #f9fafb;
            color: #6b7280;
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            font-weight: 700;
        }

        tr:hover {
            background-color: #f8fafc;
        }

        .checkbox-col {
            width: 40px;
            text-align: center;
        }

        input[type="checkbox"] {
            width: 18px;
            height: 18px;
            cursor: pointer;
            accent-color: var(--primary);
        }

        .badge {
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: bold;
            display: inline-block;
            white-space: nowrap;
        }

        .badge-reg {
            background: #e0f2fe;
            color: #0369a1;
            border: 1px solid #bae6fd;
        }

        .badge-del {
            background: #dcfce7;
            color: #15803d;
            border: 1px solid #bbf7d0;
        }

        .badge-dup {
            background: #fee2e2;
            color: #991b1b;
            border: 1px solid #fecaca;
        }

        .row-duplicate {
            background-color: #fff1f2 !important;
        }

        .action-btn {
            padding: 6px 12px;
            border-radius: 6px;
            border: none;
            cursor: pointer;
            font-size: 0.8rem;
            font-weight: 600;
            white-space: nowrap;
            transition: 0.2s;
        }

        .btn-deliver {
            background: var(--success);
            color: white;
        }

        .btn-deliver:hover {
            background: #047857;
        }

        .btn-delete {
            background: white;
            color: var(--danger);
            border: 1px solid var(--border);
        }

        .btn-delete:hover {
            background: #fee2e2;
            border-color: #fecaca;
        }

        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            padding: 20px;
        }

        .modal-overlay.active {
            display: flex;
        }

        .modal {
            background: white;
            padding: 30px;
            border-radius: 12px;
            max-width: 500px;
            width: 100%;
            text-align: center;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
            animation: slideUp 0.3s ease-out;
        }

        @keyframes slideUp {
            from {
                transform: translateY(20px);
                opacity: 0;
            }

            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .toast {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: #1f2937;
            color: white;
            padding: 14px 24px;
            border-radius: 10px;
            transform: translateY(100px);
            transition: 0.3s;
            z-index: 2000;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
        }

        .toast.show {
            transform: translateY(0);
        }

        @media (max-width: 640px) {
            .nav-brand {
                font-size: 1.1rem;
            }

            .section-title {
                flex-direction: column;
                align-items: flex-start;
            }

            .controls {
                flex-direction: column;
                align-items: stretch;
            }

            .cnic-box {
                width: 28px;
                height: 36px;
                font-size: 0.9rem;
            }

            .modal {
                padding: 20px;
            }
        }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>
        const SUPABASE_URL = 'https://jexmkavljsaksejruvih.supabase.co'
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImpleG1rYXZsanNha3NlanJ1dmloIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzA3OTk1NTUsImV4cCI6MjA4NjM3NTU1NX0.i9TVDeWygTWSc8gQ-BNrYWULUIFz6i6aEGgu-UHXnAo'
        
        // Create client - use window.supabaseClient to avoid conflicts
        window.supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY)
    </script>
</head>

<body>

    <nav>
        <div class="nav-inner">
            <div class="nav-brand">ü§≤ RationConnect <span id="nav-branch-name"></span></div>
            <div id="nav-actions"></div>
        </div>
    </nav>

    <div class="app-container">

        <!-- LOGIN VIEW -->
        <div id="view-login" class="fade-in">
            <div style="max-width: 400px; margin: 60px auto;" class="card">
                <h2 style="text-align: center; margin-bottom: 10px; color: var(--primary-dark);">System Login</h2>
                <p style="text-align: center; color: #666; margin-bottom: 25px; font-size: 0.9rem;">Access restricted to
                    authorized personnel</p>
                <form id="loginForm">
                    <div class="form-group" style="margin-bottom: 15px;">
                        <label>Email</label>
                        <input type="email" id="user" placeholder="admin@ration.local" required>
                    </div>
                    <div class="form-group" style="margin-bottom: 20px;">
                        <label>Password</label>
                        <input type="password" id="pass" placeholder="Password" required>
                    </div>
                    <button type="submit" class="submit-btn" style="background:#1f2937;">Secure Login</button>

                    <div
                        style="margin-top: 20px; background: #f0fdf4; padding: 15px; border-radius: 6px; font-size: 0.85rem; border: 1px solid #bbf7d0; color: #166534;">
                        <strong>Create users in Supabase Auth first:</strong><br>
                        admin@ration.local (role: admin)<br>
                        b1@ration.local (role: branch)<br>
                        b2@ration.local (role: branch)
                    </div>
                </form>
            </div>
        </div>

        <!-- DASHBOARD VIEW -->
        <div id="view-dashboard" class="hidden fade-in">

            <!-- ENTRY FORM -->
            <div id="entry-form-section" class="card">
                <div class="section-title">
                    <span>New Ration Entry</span>
                    <span style="font-size: 0.85rem; color: #666; font-weight: normal;">All fields are mandatory</span>
                </div>
                <form id="requestForm">
                    <div class="form-grid">
                        <div class="form-group">
                            <label>Full Name</label>
                            <input type="text" id="fullName" placeholder="Recipient Name" required>
                        </div>
                        <div class="form-group">
                            <label>Mobile Number</label>
                            <input type="text" id="mobile" placeholder="03001234567" required>
                        </div>
                        <div class="form-group">
                            <label>CNIC Number</label>
                            <div class="cnic-container">
                                <div class="cnic-group" id="g1"><input type="text" class="cnic-box" maxlength="1"
                                        required><input type="text" class="cnic-box" maxlength="1" required><input
                                        type="text" class="cnic-box" maxlength="1" required><input type="text"
                                        class="cnic-box" maxlength="1" required><input type="text" class="cnic-box"
                                        maxlength="1" required></div>
                                <span class="cnic-sep">-</span>
                                <div class="cnic-group" id="g2"><input type="text" class="cnic-box" maxlength="1"
                                        required><input type="text" class="cnic-box" maxlength="1" required><input
                                        type="text" class="cnic-box" maxlength="1" required><input type="text"
                                        class="cnic-box" maxlength="1" required><input type="text" class="cnic-box"
                                        maxlength="1" required><input type="text" class="cnic-box" maxlength="1"
                                        required><input type="text" class="cnic-box" maxlength="1" required></div>
                                <span class="cnic-sep">-</span>
                                <div class="cnic-group" id="g3"><input type="text" class="cnic-box" maxlength="1"
                                        required></div>
                            </div>
                        </div>
                    </div>

                    <div class="form-grid" style="margin-top: 15px;">
                        <div class="form-group">
                            <label>Area / Location</label>
                            <select id="area" onchange="app.toggleOtherArea(this.value)" required>
                                <option value="" disabled selected>Select Area</option>
                                <option value="DHA">DHA</option>
                                <option value="Clifton">Clifton</option>
                                <option value="Tariq Road">Tariq Road</option>
                                <option value="Others">Others</option>
                            </select>
                            <input type="text" id="otherArea" class="hidden" placeholder="Specify Area Name"
                                style="margin-top: 8px;">
                        </div>

                        <div class="form-group">
                            <label>Complete Address</label>
                            <input type="text" id="address" placeholder="House/Flat No, Street, Block" required>
                        </div>
                    </div>

                    <button type="submit" class="submit-btn">Check Eligibility & Register</button>
                </form>
            </div>

            <!-- DATA TABLE -->
            <div class="card">
                <div class="section-title">
                    <span id="list-title">Registered Recipients</span>
                </div>

                <div class="controls">
                    <input type="text" id="f-cnic" placeholder="üîç Search CNIC..." onkeyup="app.filter()">
                    <input type="text" id="f-mobile" placeholder="üîç Search Mobile..." onkeyup="app.filter()">
                    <select id="f-area" onchange="app.filter()">
                        <option value="">All Areas</option>
                        <option value="DHA">DHA</option>
                        <option value="Clifton">Clifton</option>
                        <option value="Tariq Road">Tariq Road</option>
                        <option value="Others">Others (Non-Standard)</option>
                    </select>
                    <select id="f-status" onchange="app.filter()">
                        <option value="">All Statuses</option>
                        <option value="Registered">Registered Only</option>
                        <option value="Delivered">Delivered Only</option>
                    </select>
                    <button class="action-btn" onclick="app.resetFilters()"
                        style="background:#6b7280; color:white; padding:10px 15px;">Reset</button>
                </div>

                <div id="bulk-actions-bar" class="bulk-actions hidden">
                    <div>
                        <span style="font-weight: bold;">Selected: </span>
                        <span id="selected-count">0</span> recipients
                    </div>
                    <button class="btn-bulk-approve" onclick="app.bulkDeliver()">‚úÖ Mark Selected as Delivered</button>
                </div>

                <div class="table-responsive">
                    <table id="dashTable">
                        <thead id="tableHead">
                            <tr>
                                <th class="checkbox-col"><input type="checkbox" id="selectAll"
                                        onchange="app.toggleSelectAll()"></th>
                                <th>Name</th>
                                <th>CNIC / Mobile</th>
                                <th>Area</th>
                                <th>Address</th>
                                <th>Time Stamp</th>
                                <th id="th-branch">Branch</th>
                                <th>Status</th>
                                <th id="th-actions">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="tableBody"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <div id="duplicateModal" class="modal-overlay">
        <div class="modal">
            <div style="font-size: 3rem; margin-bottom: 10px;">‚ö†Ô∏è</div>
            <h3 style="color:var(--warning); margin-bottom:10px;">Duplicate Record Found!</h3>
            <div id="duplicateMsg"
                style="background: #fffbeb; padding: 15px; border-radius: 8px; border: 1px solid #fde68a; text-align: left; font-size: 0.9rem; color: #92400e; margin-bottom: 20px;">
            </div>
            <p style="margin-bottom: 20px;">This recipient has already received ration. Do you still want to register
                them again?</p>
            <div style="display:flex; justify-content:center; gap:10px;">
                <button class="action-btn" onclick="app.modalResolve(false)"
                    style="background:#9ca3af; color:white; padding: 10px 20px; font-size:1rem;">No, Cancel</button>
                <button class="action-btn" onclick="app.modalResolve(true)"
                    style="background:var(--primary); color:white; padding: 10px 20px; font-size:1rem;">Yes, Force
                    Register</button>
            </div>
        </div>
    </div>

    <div id="toast" class="toast"><span id="toastMsg"></span></div>

    <script>
        const app = {
            currentUser: null,
            modalPromise: null,
            data: [],
            selectedIds: new Set(),

            async init() {
                this.setupCnicAutoTab();
                this.setupListeners();

                const { data: { session } } = await supabaseClient.auth.getSession()

                if (session) {
                    const { data: userData, error } = await supabaseClient
                        .from('users')
                        .select('*, branches(name)')
                        .eq('id', session.user.id)
                        .single()

                    if (userData) {
                        this.currentUser = userData
                        await this.fetchRequests()
                        this.switchView('dashboard')
                    } else {
                        await supabaseClient.auth.signOut()
                        this.switchView('login')
                    }
                } else {
                    this.switchView('login')
                }
            },

            async fetchRequests() {
                try {
                    const { data, error } = await supabaseClient
                        .from('requests')
                        .select('*, branches(name)')
                        .order('created_at', { ascending: false })

                    if (error) throw error
                    this.data = data || []
                    this.renderDash()
                } catch (error) {
                    console.error('Error fetching requests:', error)
                    this.showToast('Failed to load requests')
                }
            },

            async insertRequest(entry) {
                try {
                    const { data, error } = await supabaseClient
                        .from('requests')
                        .insert([{
                            full_name: entry.full_name,
                            cnic: entry.cnic,
                            mobile: entry.mobile,
                            area: entry.area,
                            address: entry.address,
                            status: entry.status || 'Registered',
                            branch_id: this.currentUser.branch_id,
                            is_duplicate: entry.is_duplicate || false
                        }])
                        .select()

                    if (error) throw error
                    return data[0]
                } catch (error) {
                    console.error('Error inserting request:', error)
                    this.showToast('Failed to save request')
                    throw error
                }
            },

            async updateRequest(id, updates) {
                try {
                    const { error } = await supabaseClient
                        .from('requests')
                        .update(updates)
                        .eq('id', id)

                    if (error) throw error
                } catch (error) {
                    console.error('Error updating request:', error)
                    this.showToast('Failed to update request')
                }
            },

            async deleteRequest(id) {
                try {
                    const { error } = await supabaseClient
                        .from('requests')
                        .delete()
                        .eq('id', id)

                    if (error) throw error
                } catch (error) {
                    console.error('Error deleting request:', error)
                    this.showToast('Failed to delete request')
                }
            },

            async checkDuplicate(cnic, mobile) {
                try {
                    const { data, error } = await supabaseClient
                        .rpc('check_duplicate', {
                            p_cnic: cnic,
                            p_mobile: mobile
                        })

                    if (error) throw error
                    return data && data.length > 0 ? data[0] : null
                } catch (error) {
                    console.error('Error checking duplicate:', error)
                    return null
                }
            },

            setupCnicAutoTab() {
                const boxes = document.querySelectorAll('.cnic-box');
                boxes.forEach((box, i) => {
                    box.oninput = () => {
                        if (box.value && boxes[i + 1]) boxes[i + 1].focus();
                    };

                    box.onkeydown = (e) => {
                        if (e.key === 'Backspace' && !box.value && boxes[i - 1]) boxes[i - 1].focus();
                    };

                    box.onpaste = (e) => {
                        e.preventDefault();
                        const pasteData = (e.clipboardData || window.clipboardData).getData('text');
                        const digits = pasteData.replace(/\D/g, '');

                        if (!digits) return;

                        let currentIdx = i;
                        let digitIdx = 0;

                        while (currentIdx < boxes.length && digitIdx < digits.length) {
                            boxes[currentIdx].value = digits[digitIdx];
                            currentIdx++;
                            digitIdx++;
                        }

                        if (currentIdx < boxes.length) {
                            boxes[currentIdx].focus();
                        } else {
                            boxes[boxes.length - 1].focus();
                        }
                    };
                });
            },

            setupListeners() {
                document.getElementById('loginForm').onsubmit = async (e) => {
                    e.preventDefault();
                    const email = document.getElementById('user').value.trim();
                    const password = document.getElementById('pass').value;

                    const { data, error } = await supabaseClient.auth.signInWithPassword({
                        email: email,
                        password: password
                    })

                    if (error) {
                        this.showToast(error.message);
                    } else {
                        await this.init();
                    }
                };

                document.getElementById('requestForm').onsubmit = async (e) => {
                    e.preventDefault();
                    await this.handleEntry();
                };
            },

            async handleEntry() {
                const cnicRaw = [...document.querySelectorAll('.cnic-box')].map(b => b.value).join('');
                if (cnicRaw.length !== 13) { 
                    this.showToast("Invalid CNIC length"); 
                    return; 
                }

                const formattedCnic = `${cnicRaw.slice(0, 5)}-${cnicRaw.slice(5, 12)}-${cnicRaw.slice(12)}`;
                const mobile = document.getElementById('mobile').value;
                const areaSelect = document.getElementById('area').value;
                const finalArea = (areaSelect === 'Others') ? document.getElementById('otherArea').value : areaSelect;

                if (areaSelect === 'Others' && !finalArea) {
                    this.showToast("Please specify the Area name");
                    return;
                }

                const entry = {
                    full_name: document.getElementById('fullName').value,
                    cnic: formattedCnic,
                    mobile: mobile,
                    area: finalArea,
                    address: document.getElementById('address').value,
                    status: 'Registered',
                    is_duplicate: false
                };

                const duplicate = await this.checkDuplicate(formattedCnic, mobile)

                if (duplicate) {
                    const field = duplicate.found ? (formattedCnic === duplicate.cnic ? 'CNIC' : 'Mobile') : '';
                    const msg = `This ${field} has already been registered in ${duplicate.branch_name || 'another branch'} on ${new Date(duplicate.created_at).toLocaleString()}.`;
                    
                    document.getElementById('duplicateMsg').innerHTML = `
                        <strong>‚ö†Ô∏è Alert:</strong><br>
                        ${msg}
                    `;
                    
                    const confirmed = await this.askUser();
                    if (!confirmed) return;
                    
                    entry.is_duplicate = true;
                }

                await this.insertRequest(entry);
                await this.fetchRequests();

                this.resetForm(document.getElementById('requestForm'));
                this.showToast(entry.is_duplicate ? "Duplicate Entry Added" : "Recipient Registered Successfully");
            },

            resetForm(form) {
                form.reset();
                document.querySelectorAll('.cnic-box').forEach(b => b.value = '');
                this.toggleOtherArea('');
            },

            toggleOtherArea(val) {
                const input = document.getElementById('otherArea');
                if (val === 'Others') {
                    input.classList.remove('hidden');
                    input.required = true;
                } else {
                    input.classList.add('hidden');
                    input.required = false;
                }
            },

            switchView(v) {
                document.querySelectorAll('[id^="view-"]').forEach(el => el.classList.add('hidden'));
                document.getElementById('view-' + v).classList.remove('hidden');

                if (v === 'dashboard') {
                    this.prepareDashboard();
                } else {
                    this.currentUser = null;
                }
                this.renderNav();
            },

            prepareDashboard() {
                const isAdmin = this.currentUser.role === 'admin';
                const formSection = document.getElementById('entry-form-section');

                if (isAdmin) {
                    formSection.classList.add('hidden');
                    document.getElementById('list-title').innerText = "Global Distribution Database (Admin)";
                    document.getElementById('th-branch').classList.remove('hidden');
                    document.getElementById('th-actions').classList.remove('hidden');
                } else {
                    formSection.classList.remove('hidden');
                    document.getElementById('list-title').innerText = "My Branch Requests";
                    document.getElementById('th-branch').classList.add('hidden');
                }

                this.selectedIds.clear();
            },

            getFilteredData() {
                const cTerm = document.getElementById('f-cnic').value.toLowerCase();
                const mTerm = document.getElementById('f-mobile').value.toLowerCase();
                const aTerm = document.getElementById('f-area').value;
                const sTerm = document.getElementById('f-status').value;
                const isAdmin = this.currentUser.role === 'admin';

                let baseData = isAdmin ? this.data : this.data.filter(r => r.branch_id === this.currentUser.branch_id);

                return baseData.filter(r => {
                    const matchesCnic = (r.cnic || '').toLowerCase().includes(cTerm);
                    const matchesMob = (r.mobile || '').toLowerCase().includes(mTerm);
                    let matchesArea = true;
                    if (aTerm) {
                        if (aTerm === 'Others') matchesArea = !['DHA', 'Clifton', 'Tariq Road'].includes(r.area);
                        else matchesArea = r.area === aTerm;
                    }
                    const matchesStatus = sTerm ? r.status === sTerm : true;

                    return matchesCnic && matchesMob && matchesArea && matchesStatus;
                });
            },

            renderDash() {
                const body = document.getElementById('tableBody');
                body.innerHTML = '';

                const filtered = this.getFilteredData();
                const isAdmin = this.currentUser.role === 'admin';

                document.getElementById('selectAll').checked = filtered.length > 0 && filtered.every(r => this.selectedIds.has(r.id));
                this.updateBulkBar();

                if (filtered.length === 0) {
                    body.innerHTML = '<tr><td colspan="9" style="text-align:center; padding:30px; color:#999;">No records match your filters</td></tr>';
                    return;
                }

                filtered.forEach(r => {
                    const branchName = r.branches ? r.branches.name : 'Unknown';
                    const dupClass = r.is_duplicate ? 'row-duplicate' : '';
                    const isChecked = this.selectedIds.has(r.id) ? 'checked' : '';

                    const statusBadge = r.is_duplicate
                        ? `<span class="badge badge-dup">Dup / ${r.status}</span>`
                        : `<span class="badge ${r.status === 'Delivered' ? 'badge-del' : 'badge-reg'}">${r.status}</span>`;

                    let actionHtml = '';
                    if (r.status === 'Registered') {
                        actionHtml += `<button class="action-btn btn-deliver" onclick="app.changeStatus('${r.id}', 'Delivered')">Mark Delivered</button>`;
                    }
                    if (isAdmin) {
                        actionHtml += ` <button class="action-btn btn-delete" onclick="app.handleDelete('${r.id}')">Del</button>`;
                    }

                    const tr = document.createElement('tr');
                    tr.className = dupClass;
                    tr.innerHTML = `
                        <td class="checkbox-col"><input type="checkbox" class="row-select" onchange="app.toggleSelect('${r.id}')" ${isChecked}></td>
                        <td><strong>${r.full_name}</strong></td>
                        <td>
                            <div style="font-family:monospace; font-size:0.9rem;">${r.cnic}</div>
                            <div style="font-size:0.8rem; color:#666;">${r.mobile}</div>
                        </td>
                        <td>${r.area}</td>
                        <td style="font-size:0.85rem; max-width:200px;">${r.address || ''}</td>
                        <td style="font-size:0.8rem; color:#666; white-space:nowrap;">${new Date(r.created_at).toLocaleString()}</td>
                        ${isAdmin ? `<td style="font-size:0.8rem;">${branchName}</td>` : '<td class="hidden"></td>'}
                        <td>${statusBadge}</td>
                        <td style="display:flex; gap:5px; flex-wrap:wrap;">${actionHtml}</td>
                    `;
                    body.appendChild(tr);
                });
            },

            toggleSelect(id) {
                if (this.selectedIds.has(id)) this.selectedIds.delete(id);
                else this.selectedIds.add(id);
                this.renderDash();
            },

            toggleSelectAll() {
                const filtered = this.getFilteredData();
                const allSelected = filtered.every(r => this.selectedIds.has(r.id));

                if (allSelected) {
                    filtered.forEach(r => this.selectedIds.delete(r.id));
                } else {
                    filtered.forEach(r => this.selectedIds.add(r.id));
                }
                this.renderDash();
            },

            updateBulkBar() {
                const bar = document.getElementById('bulk-actions-bar');
                const countSpan = document.getElementById('selected-count');
                if (this.selectedIds.size > 0) {
                    bar.classList.remove('hidden');
                    countSpan.innerText = this.selectedIds.size;
                } else {
                    bar.classList.add('hidden');
                }
            },

            async bulkDeliver() {
                if (!confirm(`Mark ${this.selectedIds.size} recipients as Delivered?`)) return;

                const ids = Array.from(this.selectedIds);

                try {
                    const { error } = await supabaseClient
                        .from('requests')
                        .update({ status: 'Delivered' })
                        .in('id', ids)

                    if (error) throw error

                    this.showToast(`${ids.length} records updated to Delivered`);
                    this.selectedIds.clear();
                    await this.fetchRequests();
                } catch (e) {
                    console.error(e);
                    this.showToast('Bulk update failed');
                }
            },

            async changeStatus(id, newStatus) {
                await this.updateRequest(id, { status: newStatus })
                await this.fetchRequests()
            },

            async handleDelete(id) {
                if (!confirm('Permanently delete this request?')) return

                await this.deleteRequest(id)
                await this.fetchRequests()
            },

            renderNav() {
                const nav = document.getElementById('nav-actions');
                const branchLabel = document.getElementById('nav-branch-name');
                if (this.currentUser) {
                    const branchName = this.currentUser.branches ? this.currentUser.branches.name : 'User';
                    branchLabel.innerText = branchName;
                    let html = '';
                    html += `<button class="nav-btn-danger" onclick="app.logout()">Logout</button>`;
                    nav.innerHTML = html;
                } else {
                    branchLabel.innerText = "";
                    nav.innerHTML = "";
                }
            },

            async logout() {
                await supabaseClient.auth.signOut();
                this.switchView('login');
            },

            filter() { this.renderDash(); },

            resetFilters() {
                document.getElementById('f-cnic').value = '';
                document.getElementById('f-mobile').value = '';
                document.getElementById('f-area').value = '';
                document.getElementById('f-status').value = '';
                this.renderDash();
            },

            askUser() {
                document.getElementById('duplicateModal').classList.add('active');
                return new Promise(res => { this.modalPromise = res; });
            },

            modalResolve(val) {
                document.getElementById('duplicateModal').classList.remove('active');
                if (this.modalPromise) this.modalPromise(val);
            },

            showToast(m) {
                const t = document.getElementById('toast');
                document.getElementById('toastMsg').innerText = m;
                t.classList.add('show');
                setTimeout(() => t.classList.remove('show'), 3000);
            }
        };

        app.init();
    </script>
</body>

</html>
