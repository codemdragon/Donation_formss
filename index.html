<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ration Distribution System</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        :root {
            --primary: #2563eb;
            --primary-dark: #1e40af;
            --success: #059669;
            --bg: #f3f4f6;
            --card: #ffffff;
            --text: #1f2937;
            --border: #e5e7eb;
            --danger: #dc2626;
            --warning: #f59e0b;
        }

        * {
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 0;
        }

        body {
            background-color: var(--bg);
            color: var(--text);
            line-height: 1.6;
        }

        .hidden { display: none !important; }

        .fade-in { animation: fadeIn 0.3s ease-in-out; }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        nav {
            background: var(--primary-dark);
            color: white;
            box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1);
            position: sticky;
            top: 0;
            z-index: 50;
        }

        .nav-inner {
            max-width: 1400px;
            margin: 0 auto;
            padding: 14px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 10px;
        }

        .nav-brand {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 1.3rem;
            font-weight: 700;
        }

        #nav-branch-name {
            font-weight: 400;
            font-size: 0.9rem;
            opacity: 0.9;
            background: rgba(255,255,255,0.2);
            padding: 2px 8px;
            border-radius: 4px;
            white-space: nowrap;
        }

        #nav-actions button {
            padding: 6px 14px;
            border-radius: 6px;
            border: none;
            cursor: pointer;
            font-weight: 600;
            font-size: 0.9rem;
        }

        .nav-btn-danger { background: var(--danger); color: white; }

        .app-container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
            padding-bottom: 100px;
        }

        .card {
            background: var(--card);
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1);
            margin-bottom: 20px;
            overflow: hidden;
        }

        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
            gap: 15px;
        }

        .form-group { margin-bottom: 5px; }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
            font-size: 0.9rem;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid var(--border);
            border-radius: 6px;
        }

        .cnic-container {
            display: flex;
            align-items: center;
            gap: 5px;
            flex-wrap: nowrap;
            overflow-x: auto;
        }

        .cnic-group { display: flex; gap: 4px; }

        .cnic-box {
            width: 32px;
            min-width: 25px;
            height: 40px;
            text-align: center;
            font-size: 1rem;
            font-weight: bold;
            border: 2px solid var(--border);
            border-radius: 6px;
            padding: 0;
        }

        .cnic-sep { font-weight: bold; color: #9ca3af; }

        .submit-btn {
            background: var(--primary);
            color: white;
            border: none;
            padding: 12px;
            border-radius: 6px;
            width: 100%;
            font-weight: bold;
            cursor: pointer;
            margin-top: 15px;
            transition: 0.2s;
        }

        .submit-btn:hover { background: var(--primary-dark); }
        .submit-btn:disabled { background: #9ca3af; cursor: not-allowed; }

        .section-title {
            font-size: 1.2rem;
            margin-bottom: 15px;
            color: var(--primary-dark);
            border-bottom: 2px solid #e5e7eb;
            padding-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 10px;
        }

        .controls {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 20px;
            background: #f9fafb;
            padding: 15px;
            border-radius: 8px;
            align-items: center;
        }

        .controls input,
        .controls select {
            flex: 1;
            min-width: 140px;
            padding: 10px;
            border: 1px solid var(--border);
            border-radius: 6px;
        }

        .bulk-actions {
            background: #dbeafe;
            border: 1px solid #93c5fd;
            color: #1e40af;
            padding: 10px 15px;
            border-radius: 8px;
            margin-bottom: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 10px;
        }

        .btn-bulk-approve {
            background: var(--success);
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            font-weight: bold;
            cursor: pointer;
        }

        .btn-bulk-approve:hover { background: #047857; }

        .table-responsive {
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            min-width: 900px;
        }

        th, td {
            padding: 12px 15px;
            border-bottom: 1px solid var(--border);
            text-align: left;
            vertical-align: middle;
        }

        th {
            background: #f9fafb;
            color: #6b7280;
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            font-weight: 700;
        }

        tr:hover { background-color: #f8fafc; }

        .checkbox-col { width: 40px; text-align: center; }

        input[type="checkbox"] {
            width: 18px;
            height: 18px;
            cursor: pointer;
            accent-color: var(--primary);
        }

        .badge {
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: bold;
            display: inline-block;
            white-space: nowrap;
        }

        .badge-reg { background: #e0f2fe; color: #0369a1; border: 1px solid #bae6fd; }
        .badge-del { background: #dcfce7; color: #15803d; border: 1px solid #bbf7d0; }
        .badge-dup { background: #fee2e2; color: #991b1b; border: 1px solid #fecaca; }

        .row-duplicate { background-color: #fff1f2 !important; }

        .action-btn {
            padding: 6px 12px;
            border-radius: 6px;
            border: none;
            cursor: pointer;
            font-size: 0.8rem;
            font-weight: 600;
            white-space: nowrap;
            transition: 0.2s;
        }

        .btn-deliver { background: var(--success); color: white; }
        .btn-deliver:hover { background: #047857; }

        .btn-delete { background: white; color: var(--danger); border: 1px solid var(--border); }
        .btn-delete:hover { background: #fee2e2; border-color: #fecaca; }

        .modal-overlay {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.5);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            padding: 20px;
        }

        .modal-overlay.active { display: flex; }

        .modal {
            background: white;
            padding: 30px;
            border-radius: 12px;
            max-width: 500px;
            width: 100%;
            text-align: center;
            box-shadow: 0 20px 25px -5px rgba(0,0,0,0.1);
            animation: slideUp 0.3s ease-out;
        }

        @keyframes slideUp {
            from { transform: translateY(20px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        .toast {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: #1f2937;
            color: white;
            padding: 14px 24px;
            border-radius: 10px;
            transform: translateY(100px);
            transition: 0.3s;
            z-index: 2000;
            box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1);
        }

        .toast.show { transform: translateY(0); }

        /* Loading overlay */
        .loading-overlay {
            position: fixed;
            inset: 0;
            background: rgba(255,255,255,0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
            flex-direction: column;
            gap: 15px;
        }

        .spinner {
            width: 48px;
            height: 48px;
            border: 5px solid var(--border);
            border-top-color: var(--primary);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }

        @keyframes spin { to { transform: rotate(360deg); } }

        @media (max-width: 640px) {
            .nav-brand { font-size: 1.1rem; }
            .section-title { flex-direction: column; align-items: flex-start; }
            .controls { flex-direction: column; align-items: stretch; }
            .cnic-box { width: 28px; height: 36px; font-size: 0.9rem; }
            .modal { padding: 20px; }
        }
    </style>
</head>

<body>

    <!-- Loading Overlay -->
    <div id="loadingOverlay" class="loading-overlay">
        <div class="spinner"></div>
        <div style="color: var(--primary-dark); font-weight: 600;">Connecting to Database...</div>
    </div>

    <nav>
        <div class="nav-inner">
            <div class="nav-brand">ü§≤ RationConnect <span id="nav-branch-name"></span></div>
            <div id="nav-actions"></div>
        </div>
    </nav>

    <div class="app-container">

        <!-- LOGIN VIEW -->
        <div id="view-login" class="hidden fade-in">
            <div style="max-width:400px; margin:60px auto;" class="card">
                <h2 style="text-align:center; margin-bottom:10px; color:var(--primary-dark);">System Login</h2>
                <p style="text-align:center; color:#666; margin-bottom:25px; font-size:0.9rem;">Access restricted to authorized personnel</p>
                <form id="loginForm">
                    <div class="form-group" style="margin-bottom:15px;">
                        <label>Username</label>
                        <input type="text" id="user" placeholder="e.g. admin or b1" required>
                    </div>
                    <div class="form-group" style="margin-bottom:20px;">
                        <label>Password</label>
                        <input type="password" id="pass" placeholder="Password" required>
                    </div>
                    <button type="submit" id="loginBtn" class="submit-btn" style="background:#1f2937;">Secure Login</button>
                </form>
            </div>
        </div>

        <!-- DASHBOARD VIEW -->
        <div id="view-dashboard" class="hidden fade-in">

            <!-- ENTRY FORM (Branch users only) -->
            <div id="entry-form-section" class="card">
                <div class="section-title">
                    <span>New Ration Entry</span>
                    <span style="font-size:0.85rem; color:#666; font-weight:normal;">All fields are mandatory</span>
                </div>
                <form id="requestForm">
                    <div class="form-grid">
                        <div class="form-group">
                            <label>Full Name</label>
                            <input type="text" id="fullName" placeholder="Recipient Name" required>
                        </div>
                        <div class="form-group">
                            <label>Mobile Number</label>
                            <input type="text" id="mobile" placeholder="03001234567" required>
                        </div>
                        <div class="form-group">
                            <label>CNIC Number</label>
                            <div class="cnic-container">
                                <div class="cnic-group" id="g1">
                                    <input type="text" class="cnic-box" maxlength="1" required>
                                    <input type="text" class="cnic-box" maxlength="1" required>
                                    <input type="text" class="cnic-box" maxlength="1" required>
                                    <input type="text" class="cnic-box" maxlength="1" required>
                                    <input type="text" class="cnic-box" maxlength="1" required>
                                </div>
                                <span class="cnic-sep">-</span>
                                <div class="cnic-group" id="g2">
                                    <input type="text" class="cnic-box" maxlength="1" required>
                                    <input type="text" class="cnic-box" maxlength="1" required>
                                    <input type="text" class="cnic-box" maxlength="1" required>
                                    <input type="text" class="cnic-box" maxlength="1" required>
                                    <input type="text" class="cnic-box" maxlength="1" required>
                                    <input type="text" class="cnic-box" maxlength="1" required>
                                    <input type="text" class="cnic-box" maxlength="1" required>
                                </div>
                                <span class="cnic-sep">-</span>
                                <div class="cnic-group" id="g3">
                                    <input type="text" class="cnic-box" maxlength="1" required>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="form-grid" style="margin-top:15px;">
                        <div class="form-group">
                            <label>Area / Location</label>
                            <select id="area" onchange="app.toggleOtherArea(this.value)" required>
                                <option value="" disabled selected>Select Area</option>
                                <option value="DHA">DHA</option>
                                <option value="Clifton">Clifton</option>
                                <option value="Tariq Road">Tariq Road</option>
                                <option value="Others">Others</option>
                            </select>
                            <input type="text" id="otherArea" class="hidden" placeholder="Specify Area Name" style="margin-top:8px;">
                        </div>
                        <div class="form-group">
                            <label>Complete Address</label>
                            <input type="text" id="address" placeholder="House/Flat No, Street, Block" required>
                        </div>
                    </div>

                    <button type="submit" id="submitEntryBtn" class="submit-btn">Check Eligibility & Register</button>
                </form>
            </div>

            <!-- DATA TABLE -->
            <div class="card">
                <div class="section-title">
                    <span id="list-title">Registered Recipients</span>
                    <button class="action-btn" onclick="app.loadData()" style="background:#6b7280; color:white; padding:8px 14px;">üîÑ Refresh</button>
                </div>

                <div class="controls">
                    <input type="text" id="f-cnic" placeholder="Search CNIC..." oninput="app.filter()">
                    <input type="text" id="f-mobile" placeholder="Search Mobile..." oninput="app.filter()">
                    <select id="f-area" onchange="app.filter()">
                        <option value="">All Areas</option>
                        <option value="DHA">DHA</option>
                        <option value="Clifton">Clifton</option>
                        <option value="Tariq Road">Tariq Road</option>
                        <option value="Others">Others (Non-Standard)</option>
                    </select>
                    <select id="f-status" onchange="app.filter()">
                        <option value="">All Statuses</option>
                        <option value="Registered">Registered Only</option>
                        <option value="Delivered">Delivered Only</option>
                    </select>
                    <button class="action-btn" onclick="app.resetFilters()" style="background:#6b7280; color:white; padding:10px 15px;">Reset</button>
                </div>

                <!-- Bulk Action Bar -->
                <div id="bulk-actions-bar" class="bulk-actions hidden">
                    <div><span style="font-weight:bold;">Selected: </span><span id="selected-count">0</span> recipients</div>
                    <button class="btn-bulk-approve" onclick="app.bulkDeliver()">‚úÖ Mark Selected as Delivered</button>
                </div>

                <div class="table-responsive">
                    <table id="dashTable">
                        <thead>
                            <tr>
                                <th class="checkbox-col"><input type="checkbox" id="selectAll" onchange="app.toggleSelectAll()"></th>
                                <th>Name</th>
                                <th>CNIC / Mobile</th>
                                <th>Area</th>
                                <th>Address</th>
                                <th>Time Stamp</th>
                                <th id="th-branch">Branch</th>
                                <th>Status</th>
                                <th id="th-actions">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="tableBody"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- BRANCH MANAGEMENT VIEW -->
    <div id="view-branches" class="hidden fade-in">
        <div style="max-width:1400px; margin:0 auto; padding:20px;">
        <div class="card">
            <div class="section-title">
                <span>Manage Branches</span>
                <button class="action-btn" onclick="app.switchView('dashboard')" style="background:#6b7280; color:white;">&larr; Back to Dashboard</button>
            </div>

            <div class="form-grid" style="margin-bottom:30px; background:#f9fafb; padding:20px; border-radius:8px; border:1px solid #e5e7eb;">
                <div class="form-group">
                    <label>Branch Name</label>
                    <input type="text" id="newBrName" placeholder="e.g. Saylani Gulshan">
                </div>
                <div class="form-group">
                    <label>Username</label>
                    <input type="text" id="newBrUser" placeholder="e.g. b3">
                </div>
                <div class="form-group">
                    <label>Password</label>
                    <input type="text" id="newBrPass" placeholder="e.g. pass123">
                </div>
                <div class="form-group" style="display:flex; align-items:flex-end;">
                    <button class="submit-btn" id="addBranchBtn" onclick="app.addBranch()" style="margin-top:0;">+ Add Branch</button>
                </div>
            </div>

            <div class="section-title"><span>Existing Branches</span></div>

            <div class="table-responsive">
                <table>
                    <thead>
                        <tr>
                            <th>Branch Name</th>
                            <th>Username</th>
                            <th>Password</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="branchTableBody"></tbody>
                </table>
            </div>
        </div>
        </div>
    </div>

    <!-- DUPLICATE MODAL -->
    <div id="duplicateModal" class="modal-overlay">
        <div class="modal">
            <div style="font-size:3rem; margin-bottom:10px;">‚ö†Ô∏è</div>
            <h3 style="color:var(--warning); margin-bottom:10px;">Duplicate Record Found!</h3>
            <div id="duplicateMsg" style="background:#fffbeb; padding:15px; border-radius:8px; border:1px solid #fde68a; text-align:left; font-size:0.9rem; color:#92400e; margin-bottom:20px;"></div>
            <p style="margin-bottom:20px;">This recipient has already received ration. Do you still want to register them again?</p>
            <div style="display:flex; justify-content:center; gap:10px;">
                <button class="action-btn" onclick="app.modalResolve(false)" style="background:#9ca3af; color:white; padding:10px 20px; font-size:1rem;">No, Cancel</button>
                <button class="action-btn" onclick="app.modalResolve(true)" style="background:var(--primary); color:white; padding:10px 20px; font-size:1rem;">Yes, Force Register</button>
            </div>
        </div>
    </div>

    <div id="toast" class="toast"><span id="toastMsg"></span></div>

    <script>
        // ‚îÄ‚îÄ‚îÄ SUPABASE INIT ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        const SUPABASE_URL = 'https://fmthblifhgmezsubtqsf.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZtdGhibGlmaGdtZXpzdWJ0cXNmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzEzOTM3NjQsImV4cCI6MjA4Njk2OTc2NH0.Rrp4ty1crLjurj0YP1IYQlJVS7sM75icb4kaqHeA2ZI';
        const { createClient } = supabase;
        const db = createClient(SUPABASE_URL, SUPABASE_KEY);

        // ‚îÄ‚îÄ‚îÄ APP ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        const app = {
            currentUser: null,
            modalPromise: null,
            data: [],        // cached recipients
            users: [],       // cached users
            selectedIds: new Set(),

            // ‚îÄ‚îÄ INIT ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
            async init() {
                this.setupCnicAutoTab();

                // Check session
                const savedUser = sessionStorage.getItem('rds_user');
                if (savedUser) {
                    this.currentUser = JSON.parse(savedUser);
                }

                // Load users from Supabase
                await this.loadUsers();

                // Validate session user still exists
                if (this.currentUser) {
                    const valid = this.users.find(u => u.id === this.currentUser.id);
                    if (valid) {
                        this.currentUser = valid;
                        await this.loadData();
                        this.switchView('dashboard');
                    } else {
                        sessionStorage.removeItem('rds_user');
                        this.currentUser = null;
                        this.switchView('login');
                    }
                } else {
                    this.switchView('login');
                }

                this.setupListeners();
                document.getElementById('loadingOverlay').style.display = 'none';
            },

            // ‚îÄ‚îÄ DATA LOADING ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
            async loadUsers() {
                const { data, error } = await db.from('users').select('*');
                if (error) { this.showToast('Error loading users: ' + error.message); return; }
                this.users = data || [];
            },

            async loadData() {
                const isAdmin = this.currentUser?.role === 'admin';
                let query = db
                    .from('recipients')
                    .select('*')
                    .order('created_at', { ascending: false });

                if (!isAdmin) {
                    query = query.eq('branch_id', this.currentUser.id);
                }

                const { data, error } = await query;
                if (error) { this.showToast('Error loading data: ' + error.message); return; }
                this.data = data || [];
                this.renderDash();
            },

            // ‚îÄ‚îÄ LISTENERS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
            setupListeners() {
                document.getElementById('loginForm').onsubmit = async (e) => {
                    e.preventDefault();
                    const btn = document.getElementById('loginBtn');
                    btn.disabled = true;
                    btn.textContent = 'Logging in...';

                    const uIn = document.getElementById('user').value.toLowerCase().trim();
                    const pIn = document.getElementById('pass').value;

                    // Reload users fresh on login attempt
                    await this.loadUsers();
                    const u = this.users.find(x => x.username === uIn && x.password === pIn);

                    if (u) {
                        this.currentUser = u;
                        sessionStorage.setItem('rds_user', JSON.stringify(u));
                        await this.loadData();
                        this.switchView('dashboard');
                    } else {
                        this.showToast('Invalid Credentials');
                    }

                    btn.disabled = false;
                    btn.textContent = 'Secure Login';
                };

                document.getElementById('requestForm').onsubmit = async (e) => {
                    e.preventDefault();
                    await this.handleEntry();
                };
            },

            // ‚îÄ‚îÄ ENTRY HANDLING ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
            async handleEntry() {
                const cnicRaw = [...document.querySelectorAll('.cnic-box')].map(b => b.value).join('');
                if (cnicRaw.length !== 13) { this.showToast('Invalid CNIC length'); return; }

                const formattedCnic = `${cnicRaw.slice(0,5)}-${cnicRaw.slice(5,12)}-${cnicRaw.slice(12)}`;
                const mobile = document.getElementById('mobile').value.trim();
                const areaSelect = document.getElementById('area').value;
                const finalArea = (areaSelect === 'Others') ? document.getElementById('otherArea').value.trim() : areaSelect;

                if (areaSelect === 'Others' && !finalArea) {
                    this.showToast('Please specify the Area name');
                    return;
                }

                const btn = document.getElementById('submitEntryBtn');
                btn.disabled = true;
                btn.textContent = 'Checking...';

                // Check for duplicates in Supabase
                const { data: dups } = await db
                    .from('recipients')
                    .select('*, users!inner(name)')
                    .or(`cnic.eq.${formattedCnic},mobile.eq.${mobile}`)
                    .limit(1);

                const newEntry = {
                    id: Date.now(),
                    name: document.getElementById('fullName').value.trim(),
                    cnic: formattedCnic,
                    mobile: mobile,
                    area: finalArea,
                    address: document.getElementById('address').value.trim(),
                    status: 'Registered',
                    branch_id: this.currentUser.id,
                    is_duplicate: false,
                    timestamp: this.getTimestamp(),
                };

                if (dups && dups.length > 0) {
                    const dup = dups[0];
                    const branchName = this.users.find(u => u.id === dup.branch_id)?.name || 'Unknown Branch';
                    const matchType = dup.cnic === formattedCnic ? 'CNIC' : 'Mobile Number';
                    const matchVal = dup.cnic === formattedCnic ? dup.cnic : dup.mobile;

                    document.getElementById('duplicateMsg').innerHTML =
                        `This <strong>${matchType}</strong> (<code>${matchVal}</code>) was already registered in <strong>${branchName}</strong> on <strong>${dup.timestamp}</strong>.`;

                    const allow = await this.askUser();

                    if (allow) {
                        newEntry.is_duplicate = true;
                        await this.addRecord(newEntry);
                        this.resetForm();
                    }
                } else {
                    await this.addRecord(newEntry);
                    this.resetForm();
                }

                btn.disabled = false;
                btn.textContent = 'Check Eligibility & Register';
            },

            async addRecord(entry) {
                const { error } = await db.from('recipients').insert([entry]);
                if (error) { this.showToast('Error saving record: ' + error.message); return; }
                this.data.unshift(entry);
                this.showToast(entry.is_duplicate ? 'Duplicate Entry Added' : 'Recipient Registered Successfully');
                this.renderDash();
            },

            resetForm() {
                document.getElementById('requestForm').reset();
                document.querySelectorAll('.cnic-box').forEach(b => b.value = '');
                this.toggleOtherArea('');
            },

            toggleOtherArea(val) {
                const input = document.getElementById('otherArea');
                if (val === 'Others') {
                    input.classList.remove('hidden');
                    input.required = true;
                } else {
                    input.classList.add('hidden');
                    input.required = false;
                }
            },

            // ‚îÄ‚îÄ DASHBOARD ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
            switchView(v) {
                document.querySelectorAll('[id^="view-"]').forEach(el => el.classList.add('hidden'));
                document.getElementById('view-' + v).classList.remove('hidden');

                if (v === 'dashboard') {
                    this.prepareDashboard();
                } else if (v === 'branches') {
                    this.prepareBranches();
                } else if (v === 'login') {
                    this.currentUser = null;
                    sessionStorage.removeItem('rds_user');
                }
                this.renderNav();
            },

            prepareDashboard() {
                const isAdmin = this.currentUser.role === 'admin';
                document.getElementById('entry-form-section').classList.toggle('hidden', isAdmin);
                document.getElementById('list-title').innerText = isAdmin
                    ? 'Global Distribution Database (Admin)'
                    : 'My Branch Requests';
                document.getElementById('th-branch').classList.toggle('hidden', !isAdmin);
                this.selectedIds.clear();
                this.renderDash();
            },

            getFilteredData() {
                const cTerm = document.getElementById('f-cnic').value.toLowerCase();
                const mTerm = document.getElementById('f-mobile').value.toLowerCase();
                const aTerm = document.getElementById('f-area').value;
                const sTerm = document.getElementById('f-status').value;

                return this.data.filter(r => {
                    const matchesCnic = r.cnic.toLowerCase().includes(cTerm);
                    const matchesMob = r.mobile.toLowerCase().includes(mTerm);
                    let matchesArea = true;
                    if (aTerm) {
                        if (aTerm === 'Others') matchesArea = !['DHA', 'Clifton', 'Tariq Road'].includes(r.area);
                        else matchesArea = r.area === aTerm;
                    }
                    const matchesStatus = sTerm ? r.status === sTerm : true;
                    return matchesCnic && matchesMob && matchesArea && matchesStatus;
                });
            },

            renderDash() {
                const body = document.getElementById('tableBody');
                body.innerHTML = '';
                const filtered = this.getFilteredData();
                const isAdmin = this.currentUser?.role === 'admin';

                document.getElementById('selectAll').checked =
                    filtered.length > 0 && filtered.every(r => this.selectedIds.has(r.id));
                this.updateBulkBar();

                if (filtered.length === 0) {
                    body.innerHTML = '<tr><td colspan="9" style="text-align:center; padding:30px; color:#999;">No records match your filters</td></tr>';
                    return;
                }

                filtered.forEach(r => {
                    const branchName = this.users.find(u => u.id === r.branch_id)?.name || 'Unknown';
                    const dupClass = r.is_duplicate ? 'row-duplicate' : '';
                    const isChecked = this.selectedIds.has(r.id) ? 'checked' : '';

                    const statusBadge = r.is_duplicate
                        ? `<span class="badge badge-dup">Dup / ${r.status}</span>`
                        : `<span class="badge ${r.status === 'Delivered' ? 'badge-del' : 'badge-reg'}">${r.status}</span>`;

                    let actionHtml = '';
                    if (r.status === 'Registered') {
                        actionHtml += `<button class="action-btn btn-deliver" onclick="app.setStatus(${r.id}, 'Delivered')">Mark Delivered</button>`;
                    }
                    if (isAdmin) {
                        actionHtml += ` <button class="action-btn btn-delete" onclick="app.deleteRecord(${r.id})">Del</button>`;
                    }

                    const tr = document.createElement('tr');
                    tr.className = dupClass;
                    tr.innerHTML = `
                        <td class="checkbox-col"><input type="checkbox" class="row-select" onchange="app.toggleSelect(${r.id})" ${isChecked}></td>
                        <td><strong>${r.name}</strong></td>
                        <td>
                            <div style="font-family:monospace; font-size:0.9rem;">${r.cnic}</div>
                            <div style="font-size:0.8rem; color:#666;">${r.mobile}</div>
                        </td>
                        <td>${r.area}</td>
                        <td style="font-size:0.85rem; max-width:200px;">${r.address}</td>
                        <td style="font-size:0.8rem; color:#666; white-space:nowrap;">${r.timestamp}</td>
                        ${isAdmin ? `<td style="font-size:0.8rem;">${branchName}</td>` : '<td class="hidden"></td>'}
                        <td>${statusBadge}</td>
                        <td style="display:flex; gap:5px; flex-wrap:wrap;">${actionHtml}</td>
                    `;
                    body.appendChild(tr);
                });
            },

            // ‚îÄ‚îÄ BULK ACTIONS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
            toggleSelect(id) {
                if (this.selectedIds.has(id)) this.selectedIds.delete(id);
                else this.selectedIds.add(id);
                this.renderDash();
            },

            toggleSelectAll() {
                const filtered = this.getFilteredData();
                const allSelected = filtered.every(r => this.selectedIds.has(r.id));
                if (allSelected) filtered.forEach(r => this.selectedIds.delete(r.id));
                else filtered.forEach(r => this.selectedIds.add(r.id));
                this.renderDash();
            },

            updateBulkBar() {
                const bar = document.getElementById('bulk-actions-bar');
                document.getElementById('selected-count').innerText = this.selectedIds.size;
                bar.classList.toggle('hidden', this.selectedIds.size === 0);
            },

            async bulkDeliver() {
                if (!confirm(`Mark ${this.selectedIds.size} recipients as Delivered?`)) return;

                const ids = [...this.selectedIds];
                const toUpdate = this.data.filter(r => ids.includes(r.id) && r.status !== 'Delivered');

                if (toUpdate.length === 0) {
                    this.showToast('Selected records are already Delivered');
                    return;
                }

                const { error } = await db
                    .from('recipients')
                    .update({ status: 'Delivered' })
                    .in('id', toUpdate.map(r => r.id));

                if (error) { this.showToast('Error updating records: ' + error.message); return; }

                toUpdate.forEach(r => { r.status = 'Delivered'; });
                this.selectedIds.clear();
                this.showToast(`${toUpdate.length} records updated to Delivered`);
                this.renderDash();
            },

            // ‚îÄ‚îÄ SINGLE ACTIONS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
            async setStatus(id, status) {
                const { error } = await db.from('recipients').update({ status }).eq('id', id);
                if (error) { this.showToast('Error: ' + error.message); return; }
                const rec = this.data.find(r => r.id === id);
                if (rec) rec.status = status;
                this.renderDash();
                this.showToast(`Status updated to ${status}`);
            },

            async deleteRecord(id) {
                if (!confirm('Are you sure you want to permanently delete this record?')) return;
                const { error } = await db.from('recipients').delete().eq('id', id);
                if (error) { this.showToast('Error: ' + error.message); return; }
                this.data = this.data.filter(r => r.id !== id);
                this.selectedIds.delete(id);
                this.renderDash();
                this.showToast('Record Deleted');
            },

            // ‚îÄ‚îÄ BRANCH MANAGEMENT ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
            prepareBranches() {
                this.renderBranches();
            },

            renderBranches() {
                const tbody = document.getElementById('branchTableBody');
                tbody.innerHTML = '';

                this.users.filter(u => u.id !== 'admin').forEach(u => {
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td>${u.name}</td>
                        <td>${u.username}</td>
                        <td style="font-family:monospace; letter-spacing:1px; color:#666;">${u.password}</td>
                        <td><button class="action-btn btn-delete" onclick="app.deleteBranch('${u.id}')">Delete</button></td>
                    `;
                    tbody.appendChild(tr);
                });

                if (this.users.filter(u => u.id !== 'admin').length === 0) {
                    tbody.innerHTML = '<tr><td colspan="4" style="text-align:center; padding:20px; color:#999;">No branches yet</td></tr>';
                }
            },

            async addBranch() {
                const name = document.getElementById('newBrName').value.trim();
                const username = document.getElementById('newBrUser').value.trim().toLowerCase();
                const password = document.getElementById('newBrPass').value.trim();

                if (!name || !username || !password) {
                    this.showToast('Please fill all fields');
                    return;
                }

                if (this.users.find(u => u.username === username)) {
                    this.showToast('Username already exists');
                    return;
                }

                const btn = document.getElementById('addBranchBtn');
                btn.disabled = true;
                btn.textContent = 'Adding...';

                const newBranch = {
                    id: 'b_' + Date.now(),
                    username,
                    password,
                    name,
                    role: 'branch'
                };

                const { error } = await db.from('users').insert([newBranch]);
                if (error) {
                    this.showToast('Error: ' + error.message);
                } else {
                    this.users.push(newBranch);
                    this.renderBranches();
                    this.showToast('Branch Added Successfully');
                    document.getElementById('newBrName').value = '';
                    document.getElementById('newBrUser').value = '';
                    document.getElementById('newBrPass').value = '';
                }

                btn.disabled = false;
                btn.textContent = '+ Add Branch';
            },

            async deleteBranch(id) {
                if (!confirm("Delete this branch? Their existing records will remain, but they won't be able to login.")) return;

                const { error } = await db.from('users').delete().eq('id', id);
                if (error) { this.showToast('Error: ' + error.message); return; }

                this.users = this.users.filter(u => u.id !== id);
                this.renderBranches();
                this.showToast('Branch Deleted');
            },

            // ‚îÄ‚îÄ NAV ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
            renderNav() {
                const nav = document.getElementById('nav-actions');
                const branchLabel = document.getElementById('nav-branch-name');
                if (this.currentUser) {
                    branchLabel.innerText = this.currentUser.name;
                    let html = '';
                    if (this.currentUser.role === 'admin') {
                        html += `<button onclick="app.switchView('branches')" style="background:var(--primary); color:white; margin-right:10px;">Manage Branches</button>`;
                    }
                    html += `<button class="nav-btn-danger" onclick="app.logout()">Logout</button>`;
                    nav.innerHTML = html;
                } else {
                    branchLabel.innerText = '';
                    nav.innerHTML = '';
                }
            },

            logout() { this.switchView('login'); },
            filter() { this.renderDash(); },

            resetFilters() {
                document.getElementById('f-cnic').value = '';
                document.getElementById('f-mobile').value = '';
                document.getElementById('f-area').value = '';
                document.getElementById('f-status').value = '';
                this.renderDash();
            },

            // ‚îÄ‚îÄ UTILS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
            getTimestamp() {
                const n = new Date();
                return n.getFullYear() + '-' +
                    String(n.getMonth()+1).padStart(2,'0') + '-' +
                    String(n.getDate()).padStart(2,'0') + ' ' +
                    String(n.getHours()).padStart(2,'0') + ':' +
                    String(n.getMinutes()).padStart(2,'0');
            },

            askUser() {
                document.getElementById('duplicateModal').classList.add('active');
                return new Promise(res => { this.modalPromise = res; });
            },

            modalResolve(val) {
                document.getElementById('duplicateModal').classList.remove('active');
                if (this.modalPromise) this.modalPromise(val);
            },

            showToast(m) {
                const t = document.getElementById('toast');
                document.getElementById('toastMsg').innerText = m;
                t.classList.add('show');
                setTimeout(() => t.classList.remove('show'), 3000);
            },

            setupCnicAutoTab() {
                const boxes = document.querySelectorAll('.cnic-box');
                boxes.forEach((box, i) => {
                    box.oninput = () => { if (box.value && boxes[i+1]) boxes[i+1].focus(); };
                    box.onkeydown = (e) => { if (e.key === 'Backspace' && !box.value && boxes[i-1]) boxes[i-1].focus(); };
                    box.onpaste = (e) => {
                        e.preventDefault();
                        const digits = (e.clipboardData || window.clipboardData).getData('text').replace(/\D/g,'');
                        if (!digits) return;
                        let ci = i, di = 0;
                        while (ci < boxes.length && di < digits.length) { boxes[ci].value = digits[di]; ci++; di++; }
                        if (ci < boxes.length) boxes[ci].focus();
                        else boxes[boxes.length-1].focus();
                    };
                });
            }
        };

        app.init();
    </script>
</body>
</html>
